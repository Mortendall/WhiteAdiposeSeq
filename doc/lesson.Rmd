


```{r}
significant_NR_genes <- dgeResults[["NR_effect"]] %>% 
  filter(FDR < 0.05)

NR_genes <- final_matrix %>% 
  filter(rownames(final_matrix) %in% significant_NR_genes$rn)

  heatmap <- pheatmap(NR_genes,
                      treeheight_col = 0,
                      treeheight_row = 0,
                      scale = "row",
                      legend = T,
                      na_col = "white",
                      Colv = NA,
                      na.rm = T,
                      cluster_cols = F,
                      fontsize_row = 1,
                      fontsize_col = 3,
                      cellwidth = 3,
                      cellheight = 1,
                      main = "Genes affected by NR"
  )
  heatmap
  ggsave(heatmap, filename = here("data/figures/NAD_heatmap_significant.png"), scale = 1)

volcano_genes <- significant_NR_genes %>% 
  filter(logFC >5)
  
volcano_plot <-  ggplot(significant_NR_genes, aes(x = logFC, y = -log10(FDR))) +
    geom_point()+
  geom_text(aes(x = logFC, y = -log10(FDR), label = rn), data = significant_NR_genes[significant_NR_genes$rn %in% volcano_genes$rn,],
             nudge_x = 0.02,
              nudge_y = 0.05,
              check_overlap = T)

 ggsave(volcano_plot, filename = here("data/figures/NAD_terms.png"), scale = 2.5)
  
```

```{r}

heatmap_generator <- function(count_matrix){
  Selected_candidates <- c("ADAMTS14",
"PRND",
"COL1A1",
"MXRA5Y",
"DES",
"PTX3",
"LRRTM4",
"CXCL11",
"LIPG",
"NR4A1AS",
"GOLGA5P1",
"APLN",
"KCNU1",
"SLC2A5",
"CXCL10",
"DCX",
"CHI3L2",
"CHST1",
"AC134312.1",
"LILRA5",
"ABCB5",
"SIGLEC10",
"ELOVL6",
"ADCYAP1",
"SERPINA1",
"PYCR1",
"AC253576.2",
"FLG2"
)
  Selected_candidates <- as.data.table(Selected_candidates)
  setnames(Selected_candidates, "Selected_candidates", "Gene")

  Candidates_raw <- count_matrix%>%
    filter(rownames(count_matrix) %in% Selected_candidates$Gene)
 Candidate_groups <- setup %>% 
   dplyr::select(ID, Group) 

   rownames(Candidate_groups) = Candidate_groups$ID
 Candidate_groups <- Candidate_groups %>% 
   dplyr::select(-ID)
    heatmap <- pheatmap(Candidates_raw,
                      treeheight_col = 0,
                      treeheight_row = 0,
                      scale = "row",
                      legend = T,
                      na_col = "white",
                      Colv = NA,
                      na.rm = T,
                      cluster_cols = F,
                      fontsize_row = 5,
                      fontsize_col = 5,
                      cellwidth = 5,
                      cellheight = 7,
                      annotation_col = Candidate_groups
  )
  ggsave(heatmap, filename = here::here("data/figures/Test_heatmap.png"), scale = 1.5)
  heatmap
  

}



```

```{r}


Candidates_for_sum <- Candidates_raw %>% 
  mutate(Gene = rownames(Candidates_raw))

raw_data_tidy <- pivot_longer(Candidates_for_sum, names_to = "ID",
              values_to = "abundance",
             cols= -Gene)
View(raw_data_tidy)

raw_data_plot <- inner_join(raw_data_tidy, setup)

raw_data_plot <- as.data.frame(raw_data_plot)
raw_data_plot <- raw_data_plot %>%
  dplyr::select(-Group)

summary_candidates_raw <- summarySE(raw_data_plot,
                                measurevar = "abundance",
                                groupvars = c("Gene", "Time", "Treatment"),
                                na.rm = T) %>%
  unite(Group, Time, Treatment, sep = "_", remove = F)


ggplot(summary_candidates_raw,
       aes(x = Group, 
           y = abundance, 
           fill = Group))+
  geom_col()+
  facet_wrap(~Gene)

summary_candidates_raw$Group  <- factor(summary_candidates_raw$Group, levels = c("A_Placebo", "A_NR", "B_Placebo", "B_NR"))

Flg2 <- 
  ggplot(subset(summary_candidates_raw, Gene == "FLG2"), 
       aes(x = Group, 
           y = abundance))+
  geom_col()+
  ggtitle("FLG2")+
  geom_errorbar(aes(ymin=abundance-se, 
                    ymax = abundance+se), 
                width = .1) 

Adamts14 <- 
  ggplot(subset(summary_candidates_raw, Gene == "ADAMTS14"), 
       aes(x = Group, 
           y = abundance))+
  geom_col()+
  ggtitle("Adamts14")+
  geom_errorbar(aes(ymin=abundance-se, 
                    ymax = abundance+se), 
                width = .1) 



Adamts14
Flg2


```
```{r}


PCA_plots <-
    gridExtra::grid.arrange(ncol = 1, pBase, pBase2, pBase3)
  ggplot2::ggsave(PCA_plots, filename = here("data/figures/QCplots/.png"))






```


```{r}

  heatmap_generator <- function(count_matrix){
  Selected_candidates <- c("IL7R",
"LEF1",
"ACSL6",
"CD2",
"PIM2",
"MS4A1",
"HEMGN",
"SELL",
"TRIM69",
"BTLA",
"CD3E",
"TRBC2",
"ITK",
"CST7",
"GBP5",
"POP1",
"CXCR4",
"SORL1",
"PF4",
"ANKRD36BP2",
"PADI2",
"ARHGAP15",
"SIDT1",
"CLEC4E",
"HBB",
"CCR4",
"RHOH",
"FCGR3B",
"SNORA71B",
"CAMK4",
"TRAT1",
"THEMIS",
"RASSF8-AS1",
"CYFIP2",
"BTN3A2",
"TENT5C",
"MGAM"
)
  Selected_candidates <- as.data.table(Selected_candidates)
  setnames(Selected_candidates, "Selected_candidates", "Gene")

  Candidates_raw <- count_matrix%>%
    filter(rownames(count_matrix) %in% Selected_candidates$Gene)
 Candidate_groups <- setup %>% 
   dplyr::select(ID, Group) 

   rownames(Candidate_groups) = Candidate_groups$ID
 Candidate_groups <- Candidate_groups %>% 
   dplyr::select(-ID)

 


 
   rownames(Candidate_groups) = Candidate_groups$ID
 Candidate_groups <- Candidate_groups %>% 
   dplyr::select(-ID)
    heatmap <- pheatmap(Candidates_raw,
                      treeheight_col = 0,
                      treeheight_row = 0,
                      scale = "row",
                      legend = T,
                      na_col = "white",
                      Colv = NA,
                      na.rm = T,
                      cluster_cols = F,
                      fontsize_row = 5,
                      fontsize_col = 5,
                      cellwidth = 5,
                      cellheight = 7
  )
  ggsave(heatmap, filename = here::here("data/figures/heatmap_CR_largest_FC.png"), scale = 1.5)
  heatmap
  

}



```

